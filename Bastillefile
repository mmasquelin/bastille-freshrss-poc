ARG APP_PATH=/usr/local/www/apache24/data/FreshRSS-latest
ARG NEW_DOCROOT=/usr/local/www/apache24/data/FreshRSS-latest/p

PKG apache24 mariadb105-server mod_php74 php74 php74-curl php74-gmp php74-json php74-mbstring php74-mysqli php74-zip 

SYSRC mysql_enable=YES
SYSRC apache24_enable=YES
SYSRC apache24_flags=""

SERVICE mysql-server start
CMD mysql -u root -e "ALTER USER 'root'@'localhost' IDENTIFIED BY 'adminpassword';CREATE DATABASE freshrss;CREATE USER 'freshrssuser'@'localhost' IDENTIFIED BY 'freshrsspass';GRANT ALL PRIVILEGES ON freshrss.* TO 'freshrssuser'@'localhost';FLUSH PRIVILEGES;";

CMD curl -o /tmp/freshrss-latest.zip https://codeload.github.com/FreshRSS/FreshRSS/zip/refs/tags/latest
CMD unzip -d /usr/local/www/apache24/data /tmp/freshrss-latest.zip

CMD sed -ri -e "s,/usr/local/www/apache24/data,${NEW_DOCROOT},g" /usr/local/etc/apache24/httpd.conf
CMD chgrp -R www ${APP_PATH}
CMD chown -R www ${APP_PATH}
CMD chmod go+w ${APP_PATH}/data 
CMD httpd -t

CMD cp /usr/local/etc/php.ini-production /usr/local/etc/php.ini
SYSRC php_fpm_enable=yes
SERVICE php-fpm start

CP etc /usr/local/
SERVICE apache24 start
